package com.atex.jira.plugins.utils;

import java.security.SignatureException;

import junit.framework.TestCase;

public class SignatureUtilTest extends TestCase {
    private String rawData;

    private String encodedText1 = "%7B%22pusher%22%3A%7B%22name%22%3A%22paukiatwee%22%2C%22email%22%3A%22paukiatwee%40gmail.com%22%7D%2C%22repository%22%3A%7B%22name%22%3A%22test%22%2C%22size%22%3A84%2C%22has_wiki%22%3Atrue%2C%22created_at%22%3A%222012%2F02%2F28%2000%3A17%3A24%20-0800%22%2C%22watchers%22%3A1%2C%22private%22%3Afalse%2C%22url%22%3A%22https%3A%2F%2Fgithub.com%2Fpaukiatwee%2Ftest%22%2C%22fork%22%3Afalse%2C%22pushed_at%22%3A%222012%2F02%2F28%2000%3A40%3A06%20-0800%22%2C%22has_downloads%22%3Atrue%2C%22open_issues%22%3A0%2C%22homepage%22%3A%22%22%2C%22has_issues%22%3Atrue%2C%22forks%22%3A1%2C%22description%22%3A%22%22%2C%22owner%22%3A%7B%22name%22%3A%22paukiatwee%22%2C%22email%22%3A%22paukiatwee%40gmail.com%22%7D%7D%2C%22forced%22%3Afalse%2C%22after%22%3A%22275fe6639dea454be91de383f183c9ada7d84cf6%22%2C%22head_commit%22%3A%7B%22modified%22%3A%5B%22README.md%22%5D%2C%22added%22%3A%5B%5D%2C%22removed%22%3A%5B%5D%2C%22author%22%3A%7B%22name%22%3A%22Pau%20Kiat%20Wee%22%2C%22username%22%3A%22paukiatwee%22%2C%22email%22%3A%22paukiatwee%40gmail.com%22%7D%2C%22timestamp%22%3A%222012-02-28T00%3A40%3A02-08%3A00%22%2C%22url%22%3A%22https%3A%2F%2Fgithub.com%2Fpaukiatwee%2Ftest%2Fcommit%2F275fe6639dea454be91de383f183c9ada7d84cf6%22%2C%22id%22%3A%22275fe6639dea454be91de383f183c9ada7d84cf6%22%2C%22distinct%22%3Atrue%2C%22message%22%3A%22test%22%7D%2C%22deleted%22%3Afalse%2C%22ref%22%3A%22refs%2Fheads%2Fmaster%22%2C%22commits%22%3A%5B%7B%22modified%22%3A%5B%22README.md%22%5D%2C%22added%22%3A%5B%5D%2C%22removed%22%3A%5B%5D%2C%22author%22%3A%7B%22name%22%3A%22Pau%20Kiat%20Wee%22%2C%22username%22%3A%22paukiatwee%22%2C%22email%22%3A%22paukiatwee%40gmail.com%22%7D%2C%22timestamp%22%3A%222012-02-28T00%3A40%3A02-08%3A00%22%2C%22url%22%3A%22https%3A%2F%2Fgithub.com%2Fpaukiatwee%2Ftest%2Fcommit%2F275fe6639dea454be91de383f183c9ada7d84cf6%22%2C%22id%22%3A%22275fe6639dea454be91de383f183c9ada7d84cf6%22%2C%22distinct%22%3Atrue%2C%22message%22%3A%22test%22%7D%5D%2C%22compare%22%3A%22https%3A%2F%2Fgithub.com%2Fpaukiatwee%2Ftest%2Fcompare%2F037361f...275fe66%22%2C%22before%22%3A%22037361f51eabc5ba2b69418735da2591d1a51b09%22%2C%22created%22%3Afalse%7D";
    private String cleanText1 = "{\"pusher\":{\"name\":\"paukiatwee\",\"email\":\"paukiatwee@gmail.com\"},\"repository\":{\"name\":\"test\",\"size\":84,\"has_wiki\":true,\"created_at\":\"2012/02/28 00:17:24 -0800\",\"watchers\":1,\"private\":false,\"url\":\"https://github.com/paukiatwee/test\",\"fork\":false,\"pushed_at\":\"2012/02/28 00:40:06 -0800\",\"has_downloads\":true,\"open_issues\":0,\"homepage\":\"\",\"has_issues\":true,\"forks\":1,\"description\":\"\",\"owner\":{\"name\":\"paukiatwee\",\"email\":\"paukiatwee@gmail.com\"}},\"forced\":false,\"after\":\"275fe6639dea454be91de383f183c9ada7d84cf6\",\"head_commit\":{\"modified\":[\"README.md\"],\"added\":[],\"removed\":[],\"author\":{\"name\":\"Pau Kiat Wee\",\"username\":\"paukiatwee\",\"email\":\"paukiatwee@gmail.com\"},\"timestamp\":\"2012-02-28T00:40:02-08:00\",\"url\":\"https://github.com/paukiatwee/test/commit/275fe6639dea454be91de383f183c9ada7d84cf6\",\"id\":\"275fe6639dea454be91de383f183c9ada7d84cf6\",\"distinct\":true,\"message\":\"test\"},\"deleted\":false,\"ref\":\"refs/heads/master\",\"commits\":[{\"modified\":[\"README.md\"],\"added\":[],\"removed\":[],\"author\":{\"name\":\"Pau Kiat Wee\",\"username\":\"paukiatwee\",\"email\":\"paukiatwee@gmail.com\"},\"timestamp\":\"2012-02-28T00:40:02-08:00\",\"url\":\"https://github.com/paukiatwee/test/commit/275fe6639dea454be91de383f183c9ada7d84cf6\",\"id\":\"275fe6639dea454be91de383f183c9ada7d84cf6\",\"distinct\":true,\"message\":\"test\"}],\"compare\":\"https://github.com/paukiatwee/test/compare/037361f...275fe66\",\"before\":\"037361f51eabc5ba2b69418735da2591d1a51b09\",\"created\":false}";
    private String encodedText2 = "%7B%22pusher%22%3A%7B%22name%22%3A%22wkuo%22%2C%22email%22%3A%22wuichia%40gmail.com%22%7D%2C%22repository%22%3A%7B%22name%22%3A%22test-plugin%22%2C%22size%22%3A440%2C%22has_wiki%22%3Atrue%2C%22created_at%22%3A%222012%2F01%2F18%2000%3A01%3A11%20-0800%22%2C%22private%22%3Afalse%2C%22watchers%22%3A1%2C%22url%22%3A%22https%3A%2F%2Fgithub.com%2Fwkuo%2Ftest-plugin%22%2C%22fork%22%3Afalse%2C%22pushed_at%22%3A%222012%2F02%2F27%2001%3A16%3A17%20-0800%22%2C%22has_downloads%22%3Atrue%2C%22open_issues%22%3A0%2C%22homepage%22%3A%22%22%2C%22has_issues%22%3Atrue%2C%22forks%22%3A1%2C%22description%22%3A%22%22%2C%22owner%22%3A%7B%22name%22%3A%22wkuo%22%2C%22email%22%3A%22wuichia%40gmail.com%22%7D%7D%2C%22forced%22%3Afalse%2C%22after%22%3A%227b4c94d8124fa2590f7d3eb8bc438ee6e546d3fc%22%2C%22deleted%22%3Afalse%2C%22ref%22%3A%22refs%2Fheads%2Fmaster%22%2C%22commits%22%3A%5B%7B%22added%22%3A%5B%5D%2C%22modified%22%3A%5B%22README.txt%22%5D%2C%22author%22%3A%7B%22name%22%3A%22wkuo%22%2C%22username%22%3A%22wkuo%22%2C%22email%22%3A%22wuichia%40gmail.com%22%7D%2C%22timestamp%22%3A%222012-02-27T01%3A16%3A12-08%3A00%22%2C%22removed%22%3A%5B%5D%2C%22url%22%3A%22https%3A%2F%2Fgithub.com%2Fwkuo%2Ftest-plugin%2Fcommit%2F7b4c94d8124fa2590f7d3eb8bc438ee6e546d3fc%22%2C%22id%22%3A%227b4c94d8124fa2590f7d3eb8bc438ee6e546d3fc%22%2C%22distinct%22%3Atrue%2C%22message%22%3A%22DUMMY-1%20test%20ec2%20demo%22%7D%5D%2C%22compare%22%3A%22https%3A%2F%2Fgithub.com%2Fwkuo%2Ftest-plugin%2Fcompare%2F6bc365b...7b4c94d%22%2C%22before%22%3A%226bc365b042db3e02c4860687e83dd2ed1f51d2c6%22%2C%22created%22%3Afalse%7D";
    private String cleanText2 = "{\"pusher\":{\"name\":\"wkuo\",\"email\":\"wuichia@gmail.com\"},\"repository\":{\"name\":\"test-plugin\",\"size\":440,\"has_wiki\":true,\"created_at\":\"2012/01/18 00:01:11 -0800\",\"private\":false,\"watchers\":1,\"url\":\"https://github.com/wkuo/test-plugin\",\"fork\":false,\"pushed_at\":\"2012/02/27 01:16:17 -0800\",\"has_downloads\":true,\"open_issues\":0,\"homepage\":\"\",\"has_issues\":true,\"forks\":1,\"description\":\"\",\"owner\":{\"name\":\"wkuo\",\"email\":\"wuichia@gmail.com\"}},\"forced\":false,\"after\":\"7b4c94d8124fa2590f7d3eb8bc438ee6e546d3fc\",\"deleted\":false,\"ref\":\"refs/heads/master\",\"commits\":[{\"added\":[],\"modified\":[\"README.txt\"],\"author\":{\"name\":\"wkuo\",\"username\":\"wkuo\",\"email\":\"wuichia@gmail.com\"},\"timestamp\":\"2012-02-27T01:16:12-08:00\",\"removed\":[],\"url\":\"https://github.com/wkuo/test-plugin/commit/7b4c94d8124fa2590f7d3eb8bc438ee6e546d3fc\",\"id\":\"7b4c94d8124fa2590f7d3eb8bc438ee6e546d3fc\",\"distinct\":true,\"message\":\"DUMMY-1 test ec2 demo\"}],\"compare\":\"https://github.com/wkuo/test-plugin/compare/6bc365b...7b4c94d\",\"before\":\"6bc365b042db3e02c4860687e83dd2ed1f51d2c6\",\"created\":false}";
    
    @Override
    protected void setUp() throws Exception {
        rawData ="payload=%7B%22pusher%22%3A%7B%22name%22%3A%22wkuo%22%2C%22email%22%3A%22wuichia%40gmail.com%22%7D%2C%22repository%22%3A%7B%22name%22%3A%22DummyFirst%22%2C%22size%22%3A260%2C%22has_wiki%22%3Atrue%2C%22created_at%22%3A%222011%2F12%2F15%2000%3A23%3A36%20-0800%22%2C%22watchers%22%3A1%2C%22private%22%3Afalse%2C%22fork%22%3Afalse%2C%22url%22%3A%22https%3A%2F%2Fgithub.com%2Fwkuo%2FDummyFirst%22%2C%22pushed_at%22%3A%222012%2F02%2F14%2003%3A32%3A31%20-0800%22%2C%22open_issues%22%3A0%2C%22has_downloads%22%3Atrue%2C%22homepage%22%3A%22%22%2C%22has_issues%22%3Atrue%2C%22forks%22%3A1%2C%22description%22%3A%22My%20first%20dummy%20project%22%2C%22owner%22%3A%7B%22name%22%3A%22wkuo%22%2C%22email%22%3A%22wuichia%40gmail.com%22%7D%7D%2C%22forced%22%3Afalse%2C%22after%22%3A%22462b53fb81b2129f6ed1b96f03565a62fdc96c39%22%2C%22deleted%22%3Afalse%2C%22ref%22%3A%22refs%2Fheads%2Fmaster%22%2C%22commits%22%3A%5B%7B%22added%22%3A%5B%5D%2C%22modified%22%3A%5B%22newfile.txt%22%5D%2C%22author%22%3A%7B%22name%22%3A%22wkuo%22%2C%22username%22%3A%22wkuo%22%2C%22email%22%3A%22wuichia%40gmail.com%22%7D%2C%22timestamp%22%3A%222012-02-14T03%3A32%3A13-08%3A00%22%2C%22removed%22%3A%5B%5D%2C%22url%22%3A%22https%3A%2F%2Fgithub.com%2Fwkuo%2FDummyFirst%2Fcommit%2F462b53fb81b2129f6ed1b96f03565a62fdc96c39%22%2C%22id%22%3A%22462b53fb81b2129f6ed1b96f03565a62fdc96c39%22%2C%22distinct%22%3Atrue%2C%22message%22%3A%22Compare3%20X-Hub-Signature%22%7D%5D%2C%22before%22%3A%22c699f41a26a4e60e4caf958dc5240a064cb0341f%22%2C%22compare%22%3A%22https%3A%2F%2Fgithub.com%2Fwkuo%2FDummyFirst%2Fcompare%2Fc699f41...462b53f%22%2C%22created%22%3Afalse%7D" ;
        super.setUp();
    }
    
    public void testCalculateRFC2104HMAC() throws SignatureException {
        assertEquals("fcdb2d0d7db20ca8046e3124ccdbbf0fbc904a02", SignatureUtil.calculateRFC2104HMAC(rawData, "abc"));
        assertEquals("062a6a29b37fd462222022db4f5eaf8b72f1d20e", SignatureUtil.calculateRFC2104HMAC("payload=" + encodedText1, "123"));
        assertEquals("31c426ada0b1ae02f6fe1271838838a7fe15068c", SignatureUtil.calculateRFC2104HMAC("payload=" + encodedText2, "abc"));
    }

    public void testShouldEncodeCorrectly() {
        assertEquals(encodedText1, SignatureUtil.encode(cleanText1));
        assertEquals(encodedText2, SignatureUtil.encode(cleanText2));
    }
    
    public void testEncodeNullStringShouldReturnEmptyString() {
        assertEquals("", SignatureUtil.encode(null));
    }

}
